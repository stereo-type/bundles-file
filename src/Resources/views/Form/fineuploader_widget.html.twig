{# Fine Uploader Widget #}
<div id="fineuploader-{{ field_id }}" class="slcorp-file-uploader fineuploader-wrapper"></div>

{# Модальное окно для ошибок #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>{{ 'slcorp_file.fine_uploader.error'|trans }}</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">⚠️</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">{{ 'slcorp_file.fine_uploader.ok'|trans }}</button>
        </div>
    </div>
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) - всегда массив #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# Подключение Fine Uploader библиотеки из бандла #}
<link href="{{ asset('bundles/slcorpfile/vendor/fine-uploader/fine-uploader.min.css') }}" rel="stylesheet">
<script src="{{ asset('bundles/slcorpfile/vendor/fine-uploader/fine-uploader.min.js') }}"></script>

{# Подключение стилей #}
<link href="{{ asset('bundles/slcorpfile/css/fine-uploader-widget.css') }}" rel="stylesheet">

{# Подключение JavaScript #}
<script src="{{ asset('bundles/slcorpfile/js/fine-uploader-widget.js') }}"></script>

{# Инициализация виджета #}
<script>
    (function () {
        'use strict';

        // Получаем переводы
        var translations = {
            select_file: {{ 'slcorp_file.fine_uploader.select_file'|trans|json_encode|raw }},
            select_files: {{ 'slcorp_file.fine_uploader.select_files'|trans|json_encode|raw }},
            delete: {{ 'slcorp_file.fine_uploader.delete'|trans|json_encode|raw }},
            error: {{ 'slcorp_file.fine_uploader.error'|trans|json_encode|raw }},
            ok: {{ 'slcorp_file.fine_uploader.ok'|trans|json_encode|raw }},
            uploaded: {{ 'slcorp_file.fine_uploader.uploaded'|trans|json_encode|raw }},
            max_files_exceeded: {{ 'slcorp_file.fine_uploader.max_files_exceeded'|trans|json_encode|raw }},
            file_too_big: {{ 'slcorp_file.fine_uploader.file_too_big'|trans|json_encode|raw }},
            file_type_not_allowed: {{ 'slcorp_file.fine_uploader.file_type_not_allowed'|trans|json_encode|raw }},
            upload_error: {{ 'slcorp_file.fine_uploader.upload_error'|trans|json_encode|raw }},
            delete_confirmation: {{ 'slcorp_file.fine_uploader.delete_confirmation'|trans|json_encode|raw }}
        };

        // Конфигурация для инициализации
        var widgetConfig = {
            containerId: 'fineuploader-{{ field_id }}',
            hiddenFieldId: '{{ field_id }}',
            uploadUrl: '{{ upload_url }}',
            fieldName: '{{ field_name }}',
            maxFiles: {{ form.vars.attr['data-max-files']|default(1) }},
            maxFileSize: {{ form.vars.attr['data-max-size']|default(5242880) }},
            allowedExtensions: {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}'{{ form.vars.attr['data-allowed-extensions'] }}'
            {% else %}null{% endif %},
            params: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }},
                userid: {{ userid|default('null') }}
            },
            fileData: {{ file_data|json_encode|raw }},
            translations: translations
        };

        // Функция инициализации виджета
        function initFineUploaderWidget() {
            // Проверяем, что Fine Uploader загружен
            if (typeof qq === 'undefined' || typeof qq.FineUploader === 'undefined') {
                console.error('[SlcorpFileBundle] Fine Uploader is not loaded');
                return false;
            }

            // Проверяем, что наш виджет загружен
            if (typeof window.SlcorpFileBundle === 'undefined' || typeof window.SlcorpFileBundle.FineUploaderWidget !== 'function') {
                console.error('[SlcorpFileBundle] SlcorpFileBundle.FineUploaderWidget is not loaded');
                return false;
            }

            // Инициализируем виджет
            try {
                window.SlcorpFileBundle.FineUploaderWidget(widgetConfig);
                return true;
            } catch (e) {
                console.error('[SlcorpFileBundle] Error initializing Fine Uploader widget:', e);
                return false;
            }
        }

        // Инициализируем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFineUploaderWidget);
        } else {
            // DOM уже загружен, инициализируем сразу
            initFineUploaderWidget();
        }
    })();
</script>
