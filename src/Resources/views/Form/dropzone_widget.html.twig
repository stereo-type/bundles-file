{# Dropzone Widget #}
<div id="dropzone-{{ field_id }}" class="slcorp-file-uploader dropzone" data-upload-url="{{ upload_url }}"
     data-field-name="{{ field_name }}">
    <div class="dz-message">
        <p>{{ 'slcorp_file.dropzone.default_message'|trans }}</p>
    </div>
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) - всегда массив #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# Подключение Dropzone библиотеки из бандла #}
<link href="{{ asset('bundles/slcorpfile/vendor/dropzone/dropzone.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/slcorpfile/css/dropzone-widget.css') }}" rel="stylesheet">

{# Подключение JavaScript - БЕЗ defer, чтобы скрипты загружались синхронно #}
<script src="{{ asset('bundles/slcorpfile/vendor/dropzone/dropzone.min.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/js/dropzone-widget.js') }}"></script>

{# Инициализация виджета - выполняется сразу после загрузки скриптов #}
<script>
    (function () {
        'use strict';

        // Получаем переводы
        var translations = {
            default_message: {{ 'slcorp_file.dropzone.default_message'|trans|json_encode|raw }},
            fallback_message: {{ 'slcorp_file.dropzone.fallback_message'|trans|json_encode|raw }},
            file_too_big: {{ 'slcorp_file.dropzone.file_too_big'|trans|json_encode|raw }},
            invalid_file_type: {{ 'slcorp_file.dropzone.invalid_file_type'|trans|json_encode|raw }},
            response_error: {{ 'slcorp_file.dropzone.response_error'|trans|json_encode|raw }},
            max_files_exceeded: {{ 'slcorp_file.dropzone.max_files_exceeded'|trans|json_encode|raw }},
            remove_file: {{ 'slcorp_file.dropzone.remove_file'|trans|json_encode|raw }},
            cancel_upload: {{ 'slcorp_file.dropzone.cancel_upload'|trans|json_encode|raw }},
            cancel_upload_confirmation: {{ 'slcorp_file.dropzone.cancel_upload_confirmation'|trans|json_encode|raw }}
        };

        // Конфигурация для инициализации
        var widgetConfig = {
            fieldId: 'dropzone-{{ field_id }}', // ID контейнера Dropzone, а не скрытого поля
            hiddenFieldId: '{{ field_id }}', // ID скрытого поля для хранения данных
            uploadUrl: '{{ upload_url }}',
            fieldName: '{{ field_name }}',
            maxFiles: {{ form.vars.attr['data-max-files']|default(1) }},
            maxFileSize: {{ form.vars.attr['data-max-size']|default(5242880) }},
            allowedExtensions: {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}'{{ form.vars.attr['data-allowed-extensions'] }}'
            {% else %}null{% endif %},
            params: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }},
                userid: {{ userid|default('null') }}
            },
            fileData: {{ file_data|json_encode|raw }},
            translations: translations
        };

        // Функция инициализации виджета
        function initDropzoneWidget() {
            console.log('[SlcorpFileBundle] Initializing Dropzone widget...');

            // Проверяем, что Dropzone загружен
            if (typeof Dropzone === 'undefined') {
                console.error('[SlcorpFileBundle] Dropzone is not loaded');
                return false;
            }
            console.log('[SlcorpFileBundle] Dropzone loaded:', typeof Dropzone);

            // Проверяем, что наш виджет загружен
            if (typeof window.SlcorpFileBundle === 'undefined') {
                console.error('[SlcorpFileBundle] window.SlcorpFileBundle is not defined');
                return false;
            }

            if (typeof window.SlcorpFileBundle.DropzoneWidget !== 'function') {
                console.error('[SlcorpFileBundle] SlcorpFileBundle.DropzoneWidget is not a function:', typeof window.SlcorpFileBundle.DropzoneWidget);
                console.log('[SlcorpFileBundle] window.SlcorpFileBundle:', window.SlcorpFileBundle);
                return false;
            }
            console.log('[SlcorpFileBundle] DropzoneWidget function found');

            // Проверяем наличие контейнера Dropzone
            var dropzoneElement = document.getElementById(widgetConfig.fieldId);
            if (!dropzoneElement) {
                console.error('[SlcorpFileBundle] Dropzone container not found:', widgetConfig.fieldId);
                return false;
            }
            console.log('[SlcorpFileBundle] Dropzone container found:', dropzoneElement);

            // Проверяем наличие скрытого поля
            var hiddenField = document.getElementById(widgetConfig.hiddenFieldId);
            if (!hiddenField) {
                console.error('[SlcorpFileBundle] Hidden field not found:', widgetConfig.hiddenFieldId);
                return false;
            }
            console.log('[SlcorpFileBundle] Hidden field found:', hiddenField);

            // Инициализируем виджет
            try {
                console.log('[SlcorpFileBundle] Calling DropzoneWidget with config:', widgetConfig);
                var dropzone = window.SlcorpFileBundle.DropzoneWidget(widgetConfig);
                console.log('[SlcorpFileBundle] Dropzone initialized:', dropzone);
                return true;
            } catch (e) {
                console.error('[SlcorpFileBundle] Error initializing Dropzone widget:', e);
                console.error('[SlcorpFileBundle] Stack:', e.stack);
                return false;
            }
        }

        // Инициализируем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDropzoneWidget);
        } else {
            // DOM уже загружен, инициализируем сразу
            initDropzoneWidget();
        }
    })();
</script>

