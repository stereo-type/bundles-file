{# FineUploader Widget #}
<div id="fine-uploader-{{ field_id }}" class="slcorp-file-uploader" data-upload-url="{{ upload_url }}"
     data-field-name="{{ field_name }}">
    {% if file_data and file_data|length > 0 %}
        <div class="qq-uploader-existing-file">
            <div class="qq-upload-list-selector qq-upload-list" aria-live="polite" aria-relevant="additions removals">
                {% for file in file_data %}
                    <div class="qq-upload-success" qq-file-id="{{ loop.index0 }}"
                         data-draftitemid="{{ file.draftitemid }}">
                        <span class="qq-upload-file-selector qq-upload-file">{{ file.filename }}</span>
                        <span class="qq-upload-size-selector qq-upload-size">{{ (file.filesize / 1024)|round(2) }} KB</span>
                        <a class="qq-upload-cancel-selector" href="{{ file.download_url }}" target="_blank">Скачать</a>
                </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <noscript>
            <p>Пожалуйста, включите JavaScript для загрузки файлов.</p>
        </noscript>
    {% endif %}
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('') }}{% endif %}"/>

{# Подключение FineUploader библиотеки #}
<link href="https://cdn.jsdelivr.net/npm/fine-uploader@5.16.2/fine-uploader/fine-uploader.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fine-uploader@5.16.2/fine-uploader/fine-uploader.min.js"></script>

<script>
    (function () {
        'use strict';

        var uploader = new qq.FineUploader({
            element: document.getElementById('fine-uploader-{{ field_id }}'),
            request: {
                endpoint: '{{ upload_url }}',
                params: {
                    component: '{{ component }}',
                    filearea: '{{ filearea }}',
                    itemid: {{ itemid }},
                    contextid: {{ contextid }}{% if userid is not null %},
                    userid: {{ userid }}{% endif %}
                }
            },
            callbacks: {
                onComplete: function (id, name, response) {
                    if (response.success && response.draftitemid) {
                        // Добавляем draftitemid в массив в скрытом поле
                        var hiddenField = document.getElementById('{{ field_id }}');
                        var currentValue = hiddenField.value || '[]';
                        var draftItemIds = [];

                        try {
                            draftItemIds = JSON.parse(currentValue);
                            if (!Array.isArray(draftItemIds)) {
                                draftItemIds = [];
                            }
                        } catch (e) {
                            draftItemIds = [];
                        }

                        // Добавляем новый draftitemid
                        if (!draftItemIds.includes(response.draftitemid)) {
                            draftItemIds.push(response.draftitemid);
                        }

                        hiddenField.value = JSON.stringify(draftItemIds);
                        console.log('FineUploader: draftitemid добавлен в массив', draftItemIds);
                    }
                },
                onDeleteComplete: function (id, xhr, isError) {
                    // Удаляем draftitemid из массива при удалении файла
                    var hiddenField = document.getElementById('{{ field_id }}');
                    var currentValue = hiddenField.value || '[]';
                    var draftItemIds = [];

                    try {
                        draftItemIds = JSON.parse(currentValue);
                        if (!Array.isArray(draftItemIds)) {
                            draftItemIds = [];
                        }
                    } catch (e) {
                        draftItemIds = [];
                    }

                    // Находим и удаляем draftitemid удаленного файла
                    // FineUploader не передает draftitemid напрямую, нужно найти по id
                    // Это упрощенная версия - в реальности нужно хранить связь id -> draftitemid
                    hiddenField.value = JSON.stringify(draftItemIds);
                    console.log('FineUploader: файл удален, обновлен массив', draftItemIds);
                },
                onError: function (id, name, errorReason) {
                    console.error('Ошибка загрузки файла:', errorReason);
                }
            },
            validation: {
                allowedExtensions: {{ form.vars.attr['data-allowed-extensions']|default('[]')|raw }},
                sizeLimit: {{ form.vars.attr['data-max-size']|default(5242880) }},
                itemLimit: {{ form.vars.attr['data-max-files']|default(1) }}
            }
        });
    })();
</script>

