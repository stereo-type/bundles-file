{# Plupload Widget #}
<div id="plupload-{{ field_id }}" class="slcorp-file-uploader plupload-wrapper">
    <div id="plupload-container-{{ field_id }}" class="plupload-buttons"></div>
    <div id="plupload-filelist-{{ field_id }}" class="plupload_filelist"></div>
</div>

{# Модальное окно для ошибок #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>{{ 'slcorp_file.plupload.error'|trans }}</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">⚠️</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">{{ 'slcorp_file.plupload.ok'|trans }}</button>
        </div>
    </div>
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) - всегда массив #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# Подключение jQuery (если еще не подключен) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

{# Подключение Plupload библиотеки из бандла #}
<script src="{{ asset('bundles/slcorpfile/vendor/plupload/plupload.full.min.js') }}"></script>

{# Подключение стилей #}
<link href="{{ asset('bundles/slcorpfile/css/plupload-widget.css') }}" rel="stylesheet">

{# Подключение JavaScript #}
<script src="{{ asset('bundles/slcorpfile/js/plupload-widget.js') }}"></script>

{# Инициализация виджета #}
<script>
    (function () {
        'use strict';

        // Получаем переводы
        var translations = {
            select_file: {{ 'slcorp_file.plupload.select_file'|trans|json_encode|raw }},
            select_files: {{ 'slcorp_file.plupload.select_files'|trans|json_encode|raw }},
            delete: {{ 'slcorp_file.plupload.delete'|trans|json_encode|raw }},
            error: {{ 'slcorp_file.plupload.error'|trans|json_encode|raw }},
            ok: {{ 'slcorp_file.plupload.ok'|trans|json_encode|raw }},
            uploading: {{ 'slcorp_file.plupload.uploading'|trans|json_encode|raw }},
            max_files_exceeded: {{ 'slcorp_file.plupload.max_files_exceeded'|trans|json_encode|raw }},
            file_too_big: {{ 'slcorp_file.plupload.file_too_big'|trans|json_encode|raw }},
            file_type_not_allowed: {{ 'slcorp_file.plupload.file_type_not_allowed'|trans|json_encode|raw }},
            upload_error: {{ 'slcorp_file.plupload.upload_error'|trans|json_encode|raw }},
            delete_confirmation: {{ 'slcorp_file.plupload.delete_confirmation'|trans|json_encode|raw }},
            allowed_files: {{ 'slcorp_file.plupload.allowed_files'|trans|json_encode|raw }}
        };

        // Конфигурация для инициализации
        var widgetConfig = {
            containerId: 'plupload-{{ field_id }}',
            buttonContainerId: 'plupload-container-{{ field_id }}',
            fileListId: 'plupload-filelist-{{ field_id }}',
            hiddenFieldId: '{{ field_id }}',
            uploadUrl: '{{ upload_url }}',
            fieldName: '{{ field_name }}',
            maxFiles: {{ form.vars.attr['data-max-files']|default(1) }},
            maxFileSize: {{ form.vars.attr['data-max-size']|default(5242880) }},
            allowedExtensions: {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}'{{ form.vars.attr['data-allowed-extensions'] }}'
            {% else %}null{% endif %},
            params: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }},
                userid: {{ userid|default('null') }}
            },
            fileData: {{ file_data|json_encode|raw }},
            translations: translations
        };

        // Функция инициализации виджета
        function initPluploadWidget() {
            // Проверяем, что Plupload загружен
            if (typeof plupload === 'undefined') {
                setTimeout(initPluploadWidget, 100);
                return;
            }

            // Проверяем, что наш виджет загружен
            if (typeof window.SlcorpFileBundle === 'undefined' || typeof window.SlcorpFileBundle.PluploadWidget !== 'function') {
                console.error('[SlcorpFileBundle] SlcorpFileBundle.PluploadWidget is not loaded');
                return;
            }

            // Инициализируем виджет
            try {
                window.SlcorpFileBundle.PluploadWidget(widgetConfig);
            } catch (e) {
                console.error('[SlcorpFileBundle] Error initializing Plupload widget:', e);
            }
        }

        // Инициализируем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPluploadWidget);
        } else {
            // DOM уже загружен, инициализируем сразу
            initPluploadWidget();
        }
    })();
</script>
