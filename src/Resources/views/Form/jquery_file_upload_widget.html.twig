{# jQuery File Upload Widget #}
<div id="jquery-file-upload-{{ field_id }}" class="slcorp-file-uploader jquery-file-upload">
    <div class="fileupload-buttonbar">
        <div class="fileupload-buttons">
            <span class="fileinput-button">
                <span>{% if form.vars.attr['data-max-files']|default(1) > 1 %}{{ 'slcorp_file.jquery_file_upload.select_files'|trans }}{% else %}{{ 'slcorp_file.jquery_file_upload.select_file'|trans }}{% endif %}</span>
                <input type="file"
                       name="files[]"{% if form.vars.attr['data-max-files']|default(1) > 1 %} multiple{% endif %}>
            </span>
            <button type="button" class="delete"
                    style="display: none;">{{ 'slcorp_file.jquery_file_upload.delete_selected'|trans }}</button>
        </div>
    </div>
    <div class="files"></div>
</div>

{# Модальное окно для ошибок #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>{{ 'slcorp_file.jquery_file_upload.error'|trans }}</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">⚠️</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">{{ 'slcorp_file.jquery_file_upload.ok'|trans }}</button>
        </div>
    </div>
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) - всегда массив #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# Подключение jQuery File Upload библиотеки из бандла #}
<link href="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-ui.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/slcorpfile/css/jquery-file-upload-widget.css') }}" rel="stylesheet">

{# Подключение jQuery (если еще не подключен) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

{# Подключение jQuery File Upload библиотеки #}
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.ui.widget.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.iframe-transport.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-process.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-validate.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-ui.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/js/jquery-file-upload-widget.js') }}"></script>

{# Инициализация виджета #}
<script>
    (function () {
        'use strict';

        // Получаем переводы
        var translations = {
            select_file: {{ 'slcorp_file.jquery_file_upload.select_file'|trans|json_encode|raw }},
            select_files: {{ 'slcorp_file.jquery_file_upload.select_files'|trans|json_encode|raw }},
            delete_selected: {{ 'slcorp_file.jquery_file_upload.delete_selected'|trans|json_encode|raw }},
            delete: {{ 'slcorp_file.jquery_file_upload.delete'|trans|json_encode|raw }},
            cancel: {{ 'slcorp_file.jquery_file_upload.cancel'|trans|json_encode|raw }},
            error: {{ 'slcorp_file.jquery_file_upload.error'|trans|json_encode|raw }},
            ok: {{ 'slcorp_file.jquery_file_upload.ok'|trans|json_encode|raw }},
            max_files_exceeded: {{ 'slcorp_file.jquery_file_upload.max_files_exceeded'|trans|json_encode|raw }},
            file_too_big: {{ 'slcorp_file.jquery_file_upload.file_too_big'|trans|json_encode|raw }},
            file_type_not_allowed: {{ 'slcorp_file.jquery_file_upload.file_type_not_allowed'|trans|json_encode|raw }},
            validation_error: {{ 'slcorp_file.jquery_file_upload.validation_error'|trans|json_encode|raw }},
            upload_error: {{ 'slcorp_file.jquery_file_upload.upload_error'|trans|json_encode|raw }},
            delete_confirmation: {{ 'slcorp_file.jquery_file_upload.delete_confirmation'|trans|json_encode|raw }},
            error_bad_request: {{ 'slcorp_file.jquery_file_upload.error_bad_request'|trans|json_encode|raw }},
            error_unauthorized: {{ 'slcorp_file.jquery_file_upload.error_unauthorized'|trans|json_encode|raw }},
            error_forbidden: {{ 'slcorp_file.jquery_file_upload.error_forbidden'|trans|json_encode|raw }},
            error_not_found: {{ 'slcorp_file.jquery_file_upload.error_not_found'|trans|json_encode|raw }},
            error_file_too_large: {{ 'slcorp_file.jquery_file_upload.error_file_too_large'|trans|json_encode|raw }},
            error_unsupported_media_type: {{ 'slcorp_file.jquery_file_upload.error_unsupported_media_type'|trans|json_encode|raw }},
            error_server: {{ 'slcorp_file.jquery_file_upload.error_server'|trans|json_encode|raw }},
            error_bad_gateway: {{ 'slcorp_file.jquery_file_upload.error_bad_gateway'|trans|json_encode|raw }},
            error_service_unavailable: {{ 'slcorp_file.jquery_file_upload.error_service_unavailable'|trans|json_encode|raw }},
            error_timeout: {{ 'slcorp_file.jquery_file_upload.error_timeout'|trans|json_encode|raw }},
            error_abort: {{ 'slcorp_file.jquery_file_upload.error_abort'|trans|json_encode|raw }},
            error_parser: {{ 'slcorp_file.jquery_file_upload.error_parser'|trans|json_encode|raw }}
        };

        // Конфигурация для инициализации
        var widgetConfig = {
            containerId: 'jquery-file-upload-{{ field_id }}',
            hiddenFieldId: '{{ field_id }}',
            uploadUrl: '{{ upload_url }}',
            fieldName: '{{ field_name }}',
            maxFiles: {{ form.vars.attr['data-max-files']|default(1) }},
            maxFileSize: {{ form.vars.attr['data-max-size']|default(5242880) }},
            allowedExtensions: {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}'{{ form.vars.attr['data-allowed-extensions'] }}'
            {% else %}null{% endif %},
            params: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }},
                userid: {{ userid|default('null') }}
            },
            fileData: {{ file_data|json_encode|raw }},
            translations: translations
        };

        // Функция инициализации виджета
        function initJQueryFileUploadWidget() {
            // Проверяем, что jQuery загружен
            if (typeof jQuery === 'undefined') {
                console.error('[SlcorpFileBundle] jQuery is not loaded');
                return false;
            }

            // Проверяем, что jQuery File Upload загружен
            if (typeof jQuery.fn.fileupload === 'undefined') {
                console.error('[SlcorpFileBundle] jQuery File Upload plugin is not loaded');
                return false;
            }

            // Проверяем, что наш виджет загружен
            if (typeof window.SlcorpFileBundle === 'undefined' || typeof window.SlcorpFileBundle.JQueryFileUploadWidget !== 'function') {
                console.error('[SlcorpFileBundle] SlcorpFileBundle.JQueryFileUploadWidget is not loaded');
                return false;
            }

            // Инициализируем виджет
            try {
                window.SlcorpFileBundle.JQueryFileUploadWidget(widgetConfig);
                return true;
            } catch (e) {
                console.error('[SlcorpFileBundle] Error initializing jQuery File Upload widget:', e);
                return false;
            }
        }

        // Инициализируем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initJQueryFileUploadWidget);
        } else {
            // DOM уже загружен, инициализируем сразу
            initJQueryFileUploadWidget();
        }
    })();
</script>
