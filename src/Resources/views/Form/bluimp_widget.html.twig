{# Blueimp Widget - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<div id="bluimp-{{ field_id }}" class="slcorp-file-uploader bluimp-wrapper">
    <div class="fileupload-buttonbar">
        <div class="fileupload-buttons">
            <span class="fileinput-button">
                <span>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª{% if form.vars.attr['data-max-files']|default(1) > 1 %}—ã{% endif %}</span>
                <input type="file"
                       name="files[]"{% if form.vars.attr['data-max-files']|default(1) > 1 %} multiple{% endif %}>
            </span>
        </div>
    </div>
    <div class="files"></div>
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>–û—à–∏–±–∫–∞</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">–û–ö</button>
        </div>
    </div>
</div>

{# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ draft itemid (JSON) - –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Blueimp File Upload –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<link href="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/css/jquery.fileupload.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/css/jquery.fileupload-ui.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/vendor/jquery.ui.widget.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.iframe-transport.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-process.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-validate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-ui.js"></script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è Blueimp */
    #bluimp-{{ field_id }}.bluimp-wrapper {
        font-family: Arial, sans-serif;
    }

    #bluimp-{{ field_id }} .fileupload-buttonbar {
        margin-bottom: 20px;
    }

    #bluimp-{{ field_id }} .fileinput-button {
        position: relative;
        display: inline-block;
        overflow: hidden;
    }

    #bluimp-{{ field_id }} .fileinput-button input {
        position: absolute;
        top: 0;
        right: 0;
        margin: 0;
        opacity: 0;
        filter: alpha(opacity=0);
        font-size: 200px;
        direction: ltr;
        cursor: pointer;
    }

    #bluimp-{{ field_id }} .fileinput-button span {
        display: inline-block;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.2s;
    }

    #bluimp-{{ field_id }} .fileinput-button:hover span {
        background: #0056b3;
    }

    #bluimp-{{ field_id }} .files {
        margin-top: 20px;
    }

    #bluimp-{{ field_id }} .files .template-upload,
    #bluimp-{{ field_id }} .files .template-download {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #bluimp-{{ field_id }} .files .preview {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    #bluimp-{{ field_id }} .files .preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #bluimp-{{ field_id }} .files .name {
        flex: 1;
        min-width: 0;
        font-weight: 500;
        margin-bottom: 5px;
        word-break: break-word;
    }

    #bluimp-{{ field_id }} .files .size {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
    }

    #bluimp-{{ field_id }} .files .progress {
        width: 100%;
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    #bluimp-{{ field_id }} .files .progress .progress-bar {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
        border-radius: 3px;
    }

    #bluimp-{{ field_id }} .files .start,
    #bluimp-{{ field_id }} .files .cancel,
    #bluimp-{{ field_id }} .files .delete {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
        margin-left: 10px;
    }

    #bluimp-{{ field_id }} .files .start:hover,
    #bluimp-{{ field_id }} .files .cancel:hover,
    #bluimp-{{ field_id }} .files .delete:hover {
        background: #c82333;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–æ–∫ */
    #error-modal-{{ field_id }} {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #error-modal-{{ field_id }} .error-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    #error-modal-{{ field_id }} .error-modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #error-modal-{{ field_id }} .error-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    #error-modal-{{ field_id }} .error-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 20px;
        font-weight: 600;
    }

    #error-modal-{{ field_id }} .error-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    #error-modal-{{ field_id }} .error-modal-body {
        padding: 30px 24px;
        text-align: center;
    }

    #error-modal-{{ field_id }} .error-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    #error-modal-{{ field_id }} .error-message {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        word-wrap: break-word;
    }

    #error-modal-{{ field_id }} .error-modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e9ecef;
        text-align: right;
        background: #f8f9fa;
    }

    #error-modal-{{ field_id }} .error-modal-ok {
        padding: 10px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-ok:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
</style>

<script>
    (function () {
        'use strict';

        var $hiddenField = $('#{{ field_id }}');
        var maxFiles = {{ form.vars.attr['data-max-files']|default(1) }};
        var maxFileSize = {{ form.vars.attr['data-max-size']|default(5242880) }};
        var fileData = {{ file_data|json_encode|raw }};
        var uploadedFiles = [];

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        var currentValue = $hiddenField.val() || '[]';
        try {
            var parsed = JSON.parse(currentValue);
            $hiddenField.val(Array.isArray(parsed) ? JSON.stringify(parsed) : JSON.stringify(parsed ? [parsed] : []));
        } catch (e) {
            $hiddenField.val(currentValue && currentValue !== '[]' ? JSON.stringify([currentValue]) : '[]');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
        function updateHiddenField() {
            var draftItemIds = uploadedFiles.map(function (file) {
                return file.draftitemid;
            });
            $hiddenField.val(JSON.stringify(draftItemIds));
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫
        function showErrorModal(message) {
            var $modal = $('#error-modal-{{ field_id }}');
            $modal.find('.error-message').text(message);
            $modal.fadeIn(200);
        }

        function hideErrorModal() {
            $('#error-modal-{{ field_id }}').fadeOut(200);
        }

        $('#error-modal-{{ field_id }} .error-modal-close, #error-modal-{{ field_id }} .error-modal-ok, #error-modal-{{ field_id }} .error-modal-overlay').on('click', hideErrorModal);
        $('#error-modal-{{ field_id }} .error-modal-content').on('click', function (e) {
            e.stopPropagation();
        });

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö MIME —Ç–∏–ø–æ–≤ –¥–ª—è Blueimp
        var allowedMimeTypes = [];
        {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}
        allowedMimeTypes = '{{ form.vars.attr['data-allowed-extensions'] }}'.split(',').map(function (type) {
            return type.trim();
        }).filter(function (type) {
            return type.length > 0;
        });
        {% endif %}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Blueimp File Upload - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        $('#bluimp-{{ field_id }}').fileupload({
            url: '{{ upload_url }}',
            dataType: 'json',
            autoUpload: true,
            maxFileSize: maxFileSize,
            maxNumberOfFiles: maxFiles,
            acceptFileTypes: allowedMimeTypes.length > 0 ? new RegExp('(' + allowedMimeTypes.map(function (mime) {
                var parts = mime.split('/');
                if (parts.length === 2) {
                    var ext = parts[1];
                    if (ext === 'jpeg') ext = 'jpg|jpeg';
                    return ext;
                }
                return '';
            }).filter(function (ext) {
                return ext.length > 0;
            }).join('|') + ')$', 'i') : undefined,
            formData: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }}
                {% if userid is not null %},
                userid: {{ userid }}
                {% endif %}
            },
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã Blueimp
            filesContainer: $('#bluimp-{{ field_id }} .files'),
            uploadTemplateId: null,
            downloadTemplateId: null,
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            add: function (e, data) {
                // –ï—Å–ª–∏ maxFiles = 1, —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∞–π–ª—ã
                if (maxFiles === 1 && uploadedFiles.length >= 1) {
                    $('#bluimp-{{ field_id }} .files').empty();
                    uploadedFiles = [];
                    updateHiddenField();
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
                if (uploadedFiles.length + data.files.length > maxFiles) {
                    showErrorModal('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: ' + maxFiles);
                    return false;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É Blueimp
                data.context = $('<div class="template-upload">' +
                    '<div class="preview"><span style="font-size: 40px; color: #ccc;">üìÑ</span></div>' +
                    '<div style="flex: 1;">' +
                    '<div class="name"></div>' +
                    '<div class="size"></div>' +
                    '<div class="progress"><div class="progress-bar" style="width: 0%"></div></div>' +
                    '</div>' +
                    '<button type="button" class="cancel">–û—Ç–º–µ–Ω–∞</button>' +
                    '</div>').appendTo('#bluimp-{{ field_id }} .files');

                // –ü—Ä–µ–≤—å—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                if (data.files[0].type && data.files[0].type.startsWith('image/')) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        data.context.find('.preview').html('<img src="' + e.target.result + '">');
                    };
                    reader.readAsDataURL(data.files[0]);
                }

                data.context.find('.name').text(data.files[0].name);
                data.context.find('.size').text((data.files[0].size / 1024).toFixed(2) + ' KB');

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                data.submit();
            },
            progress: function (e, data) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                var progress = parseInt(data.loaded / data.total * 100, 10);
                data.context.find('.progress-bar').css('width', progress + '%');
            },
            done: function (e, data) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                try {
                    var result = data.result[0];
                    if (result && result.draftitemid) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç - —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                        var isImage = result.url && result.name.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                        var previewHtml = '';
                        if (isImage && result.url) {
                            previewHtml = '<img src="' + result.url + '" alt="' + result.name + '">';
                        } else {
                            previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                        }

                        data.context.attr('data-draftitemid', result.draftitemid);
                        data.context.html(
                            '<div class="preview">' + previewHtml + '</div>' +
                            '<div style="flex: 1;">' +
                            '<div class="name">' + result.name + '</div>' +
                            '<div class="size">' + (result.size / 1024).toFixed(2) + ' KB</div>' +
                            '</div>' +
                            '<button type="button" class="delete" data-draftitemid="' + result.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>'
                        );

                        uploadedFiles.push({
                            draftitemid: result.draftitemid,
                            filename: result.name
                        });
                        updateHiddenField();
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞', e);
                    data.context.remove();
                }
            },
            fail: function (e, data) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                var errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';
                if (data.errorThrown) {
                    errorMessage = data.errorThrown;
                } else if (data.result && data.result[0] && data.result[0].error) {
                    errorMessage = data.result[0].error;
                }
                showErrorModal(errorMessage);
                data.context.remove();
            }
        }).on('fileuploadprocessalways', function (e, data) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            if (data.files.error) {
                showErrorModal(data.files[0].error);
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        if (fileData && Array.isArray(fileData) && fileData.length > 0) {
            var $files = $('#bluimp-{{ field_id }} .files');
            fileData.forEach(function (file) {
                var isImage = file.mimetype && file.mimetype.startsWith('image/');
                var previewHtml = '';
                if (isImage && file.download_url) {
                    previewHtml = '<img src="' + file.download_url + '" alt="' + file.filename + '">';
                } else {
                    previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                }

                var $fileItem = $('<div class="template-download" data-draftitemid="' + file.draftitemid + '">' +
                    '<div class="preview">' + previewHtml + '</div>' +
                    '<div style="flex: 1;">' +
                    '<div class="name">' + file.filename + '</div>' +
                    '<div class="size">' + (file.filesize / 1024).toFixed(2) + ' KB</div>' +
                    '</div>' +
                    '<button type="button" class="delete" data-draftitemid="' + file.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                    '</div>');
                $files.append($fileItem);

                uploadedFiles.push({
                    draftitemid: file.draftitemid,
                    filename: file.filename
                });
            });
            updateHiddenField();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        $(document).on('click', '#bluimp-{{ field_id }} .delete', function () {
            var draftitemid = $(this).data('draftitemid');
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                uploadedFiles = uploadedFiles.filter(function (file) {
                    return file.draftitemid !== draftitemid;
                });
                updateHiddenField();
                $(this).closest('.template-upload, .template-download').remove();
            }
        });
    })();
</script>

