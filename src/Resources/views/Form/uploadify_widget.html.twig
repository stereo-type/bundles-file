{# Uploadify Widget - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<div id="uploadify-{{ field_id }}" class="slcorp-file-uploader uploadify-wrapper">
    <div id="uploadify-button-{{ field_id }}"></div>
    <div id="uploadify-queue-{{ field_id }}" class="uploadify-queue"></div>
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>–û—à–∏–±–∫–∞</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">–û–ö</button>
        </div>
    </div>
</div>

{# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ draft itemid (JSON) - –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery –∏ Uploadify –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uploadify@1.0.7/index.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jquery.uploadify@3.2.1/uploadify.css" rel="stylesheet">

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è Uploadify */
    #uploadify-{{ field_id }}.uploadify-wrapper {
        font-family: Arial, sans-serif;
    }

    #uploadify-{{ field_id }} .uploadify-button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }

    #uploadify-{{ field_id }} .uploadify-button:hover {
        background: #0056b3;
    }

    #uploadify-{{ field_id }} .uploadify-queue {
        margin-top: 20px;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-preview {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-info {
        flex: 1;
        min-width: 0;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-name {
        font-weight: 500;
        margin-bottom: 5px;
        word-break: break-word;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-size {
        color: #666;
        font-size: 14px;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .uploadify-progress {
        width: 100%;
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 10px;
    }

    #uploadify-{{ field_id }} .uploadify-progress-bar {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
        border-radius: 3px;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .file-actions {
        margin-left: 15px;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .cancel,
    #uploadify-{{ field_id }} .uploadify-queue-item .delete {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }

    #uploadify-{{ field_id }} .uploadify-queue-item .cancel:hover,
    #uploadify-{{ field_id }} .uploadify-queue-item .delete:hover {
        background: #c82333;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–æ–∫ */
    #error-modal-{{ field_id }} {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #error-modal-{{ field_id }} .error-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    #error-modal-{{ field_id }} .error-modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #error-modal-{{ field_id }} .error-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    #error-modal-{{ field_id }} .error-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 20px;
        font-weight: 600;
    }

    #error-modal-{{ field_id }} .error-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    #error-modal-{{ field_id }} .error-modal-body {
        padding: 30px 24px;
        text-align: center;
    }

    #error-modal-{{ field_id }} .error-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    #error-modal-{{ field_id }} .error-message {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        word-wrap: break-word;
    }

    #error-modal-{{ field_id }} .error-modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e9ecef;
        text-align: right;
        background: #f8f9fa;
    }

    #error-modal-{{ field_id }} .error-modal-ok {
        padding: 10px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-ok:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
</style>

<script>
    (function () {
        'use strict';

        var $hiddenField = $('#{{ field_id }}');
        var maxFiles = {{ form.vars.attr['data-max-files']|default(1) }};
        var maxFileSize = {{ form.vars.attr['data-max-size']|default(5242880) }};
        var fileData = {{ file_data|json_encode|raw }};
        var uploadedFiles = [];

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        var currentValue = $hiddenField.val() || '[]';
        try {
            var parsed = JSON.parse(currentValue);
            $hiddenField.val(Array.isArray(parsed) ? JSON.stringify(parsed) : JSON.stringify(parsed ? [parsed] : []));
        } catch (e) {
            $hiddenField.val(currentValue && currentValue !== '[]' ? JSON.stringify([currentValue]) : '[]');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
        function updateHiddenField() {
            var draftItemIds = uploadedFiles.map(function (file) {
                return file.draftitemid;
            });
            $hiddenField.val(JSON.stringify(draftItemIds));
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫
        function showErrorModal(message) {
            var $modal = $('#error-modal-{{ field_id }}');
            $modal.find('.error-message').text(message);
            $modal.fadeIn(200);
        }

        function hideErrorModal() {
            $('#error-modal-{{ field_id }}').fadeOut(200);
        }

        $('#error-modal-{{ field_id }} .error-modal-close, #error-modal-{{ field_id }} .error-modal-ok, #error-modal-{{ field_id }} .error-modal-overlay').on('click', hideErrorModal);
        $('#error-modal-{{ field_id }} .error-modal-content').on('click', function (e) {
            e.stopPropagation();
        });

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö MIME —Ç–∏–ø–æ–≤ –¥–ª—è Uploadify
        var allowedMimeTypes = [];
        {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}
        allowedMimeTypes = '{{ form.vars.attr['data-allowed-extensions'] }}'.split(',').map(function (type) {
            return type.trim();
        }).filter(function (type) {
            return type.length > 0;
        });
        {% endif %}

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º MIME —Ç–∏–ø—ã –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è Uploadify
        var fileExt = '';
        if (allowedMimeTypes.length > 0) {
            fileExt = allowedMimeTypes.map(function (mime) {
                var parts = mime.split('/');
                if (parts.length === 2) {
                    var ext = parts[1];
                    if (ext === 'jpeg') ext = 'jpg,jpeg';
                    return ext;
                }
                return '';
            }).filter(function (ext) {
                return ext.length > 0;
            }).join(';');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Uploadify - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        $('#uploadify-button-{{ field_id }}').uploadify({
            'swf': 'https://cdn.jsdelivr.net/npm/jquery.uploadify@3.2.1/uploadify.swf',
            'uploader': '{{ upload_url }}',
            'buttonText': '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª{% if form.vars.attr['data-max-files']|default(1) > 1 %}—ã{% endif %}',
            'fileTypeExts': fileExt || '*.*',
            'fileSizeLimit': (maxFileSize / 1048576) + 'MB',
            'multi': maxFiles > 1,
            'queueSizeLimit': maxFiles,
            'formData': {
                'component': '{{ component }}',
                'filearea': '{{ filearea }}',
                'itemid': {{ itemid }},
                'contextid': {{ contextid }}
                {% if userid is not null %},
                'userid': {{ userid }}
                {% endif %}
            },
            'onUploadSuccess': function (file, data, response) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                try {
                    var result = typeof data === 'string' ? JSON.parse(data) : data;
                    if (result.success && result.draftitemid) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –æ—á–µ—Ä–µ–¥–∏ - —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                        var queueItem = $('#uploadify-{{ field_id }}').data('uploadify').queueData[file.id];
                        if (queueItem) {
                            var $queueItem = $(queueItem.queueItem);
                            var isImage = result.url && file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                            var previewHtml = '';
                            if (isImage && result.url) {
                                previewHtml = '<img src="' + result.url + '" alt="' + result.name + '">';
                            } else {
                                previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                            }

                            $queueItem.attr('data-draftitemid', result.draftitemid);
                            $queueItem.html(
                                '<div style="display: flex; align-items: center; width: 100%;">' +
                                '<div class="file-preview">' + previewHtml + '</div>' +
                                '<div class="file-info">' +
                                '<div class="file-name">' + result.name + '</div>' +
                                '<div class="file-size">' + (result.size / 1024).toFixed(2) + ' KB</div>' +
                                '</div>' +
                                '<div class="file-actions">' +
                                '<button type="button" class="delete" data-draftitemid="' + result.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                                '</div>' +
                                '</div>'
                            );
                        }

                        uploadedFiles.push({
                            draftitemid: result.draftitemid,
                            filename: result.name
                        });
                        updateHiddenField();
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞', e);
                }
            },
            'onUploadError': function (file, errorCode, errorMsg, errorString) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                var errorMessage = errorMsg || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';
                if (errorString) {
                    try {
                        var errorResponse = typeof errorString === 'string' ? JSON.parse(errorString) : errorString;
                        if (errorResponse.error) {
                            errorMessage = errorResponse.error;
                        }
                    } catch (e) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                }
                showErrorModal(errorMessage);
            },
            'onSelectError': function (file, errorCode, errorMsg) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
                var errorMessage = errorMsg || '–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞';
                if (errorCode === SWFUpload.UPLOAD_ERROR.FILE_EXCEEDS_SIZE_LIMIT) {
                    errorMessage = '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ' + (maxFileSize / 1048576).toFixed(2) + ' –ú–ë';
                } else if (errorCode === SWFUpload.UPLOAD_ERROR.ZERO_BYTE_FILE) {
                    errorMessage = '–§–∞–π–ª –ø—É—Å—Ç–æ–π';
                } else if (errorCode === SWFUpload.UPLOAD_ERROR.INVALID_FILETYPE) {
                    errorMessage = '–¢–∏–ø —Ñ–∞–π–ª–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω';
                }
                showErrorModal(errorMessage);
            },
            'onQueueFull': function (event, queueSizeLimit) {
                showErrorModal('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: ' + queueSizeLimit);
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        if (fileData && Array.isArray(fileData) && fileData.length > 0) {
            var $queue = $('#uploadify-queue-{{ field_id }}');
            fileData.forEach(function (file) {
                var isImage = file.mimetype && file.mimetype.startsWith('image/');
                var previewHtml = '';
                if (isImage && file.download_url) {
                    previewHtml = '<img src="' + file.download_url + '" alt="' + file.filename + '">';
                } else {
                    previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                }

                var $fileItem = $('<div class="uploadify-queue-item" data-draftitemid="' + file.draftitemid + '">' +
                    '<div style="display: flex; align-items: center; width: 100%;">' +
                    '<div class="file-preview">' + previewHtml + '</div>' +
                    '<div class="file-info">' +
                    '<div class="file-name">' + file.filename + '</div>' +
                    '<div class="file-size">' + (file.filesize / 1024).toFixed(2) + ' KB</div>' +
                    '</div>' +
                    '<div class="file-actions">' +
                    '<button type="button" class="delete" data-draftitemid="' + file.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>');
                $queue.append($fileItem);

                uploadedFiles.push({
                    draftitemid: file.draftitemid,
                    filename: file.filename
                });
            });
            updateHiddenField();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        $(document).on('click', '#uploadify-queue-{{ field_id }} .delete', function () {
            var draftitemid = $(this).data('draftitemid');
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                uploadedFiles = uploadedFiles.filter(function (file) {
                    return file.draftitemid !== draftitemid;
                });
                updateHiddenField();
                $(this).closest('.uploadify-queue-item').remove();
            }
        });
    })();
</script>

