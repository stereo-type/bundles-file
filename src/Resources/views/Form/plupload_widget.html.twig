{# Plupload Widget - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<div id="plupload-{{ field_id }}" class="slcorp-file-uploader plupload-wrapper">
    <div id="plupload-container-{{ field_id }}" class="plupload-buttons"></div>
    <div id="plupload-filelist-{{ field_id }}" class="plupload_filelist"></div>
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>–û—à–∏–±–∫–∞</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">–û–ö</button>
        </div>
    </div>
</div>

{# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ draft itemid (JSON) - –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Plupload –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<script src="https://cdn.jsdelivr.net/npm/plupload@2.3.9/js/plupload.full.min.js"></script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è Plupload */
    #plupload-{{ field_id }}.plupload-wrapper {
        font-family: Arial, sans-serif;
    }

    #plupload-{{ field_id }} .plupload-buttons {
        margin-bottom: 20px;
    }

    #plupload-{{ field_id }} .plupload_button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s;
    }

    #plupload-{{ field_id }} .plupload_button:hover {
        background: #0056b3;
    }

    #plupload-{{ field_id }} .plupload_filelist {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #plupload-{{ field_id }} .plupload_file {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #plupload-{{ field_id }} .plupload_file_content {
        display: flex;
        align-items: center;
        flex: 1;
    }

    #plupload-{{ field_id }} .plupload_file_preview {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    #plupload-{{ field_id }} .plupload_file_preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #plupload-{{ field_id }} .plupload_file_info {
        flex: 1;
        min-width: 0;
    }

    #plupload-{{ field_id }} .plupload_file_name {
        font-weight: 500;
        margin-bottom: 5px;
        word-break: break-word;
    }

    #plupload-{{ field_id }} .plupload_file_size {
        color: #666;
        font-size: 14px;
    }

    #plupload-{{ field_id }} .plupload_file_progress {
        width: 100%;
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 10px;
    }

    #plupload-{{ field_id }} .plupload_file_progress_bar {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
        border-radius: 3px;
    }

    #plupload-{{ field_id }} .plupload_file_action {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
        margin-left: 15px;
    }

    #plupload-{{ field_id }} .plupload_file_action:hover {
        background: #c82333;
    }

    #plupload-{{ field_id }} .plupload_file_status {
        margin-left: 15px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
    }

    #plupload-{{ field_id }} .plupload_file_status.uploading {
        background: #fff3cd;
        color: #856404;
    }

    #plupload-{{ field_id }} .plupload_file_status.success {
        background: #d4edda;
        color: #155724;
    }

    #plupload-{{ field_id }} .plupload_file_status.error {
        background: #f8d7da;
        color: #721c24;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–æ–∫ */
    #error-modal-{{ field_id }} {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #error-modal-{{ field_id }} .error-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    #error-modal-{{ field_id }} .error-modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #error-modal-{{ field_id }} .error-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    #error-modal-{{ field_id }} .error-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 20px;
        font-weight: 600;
    }

    #error-modal-{{ field_id }} .error-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    #error-modal-{{ field_id }} .error-modal-body {
        padding: 30px 24px;
        text-align: center;
    }

    #error-modal-{{ field_id }} .error-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    #error-modal-{{ field_id }} .error-message {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        word-wrap: break-word;
    }

    #error-modal-{{ field_id }} .error-modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e9ecef;
        text-align: right;
        background: #f8f9fa;
    }

    #error-modal-{{ field_id }} .error-modal-ok {
        padding: 10px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-ok:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
</style>

<script>
    (function () {
        'use strict';

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Plupload
        function initPlupload() {
            if (typeof plupload === 'undefined') {
                setTimeout(initPlupload, 100);
                return;
            }

            var $hiddenField = $('#{{ field_id }}');
            var maxFiles = {{ form.vars.attr['data-max-files']|default(1) }};
            var maxFileSize = {{ form.vars.attr['data-max-size']|default(5242880) }};
            var fileData = {{ file_data|json_encode|raw }};
            var uploadedFiles = [];

            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
            var currentValue = $hiddenField.val() || '[]';
            try {
                var parsed = JSON.parse(currentValue);
                $hiddenField.val(Array.isArray(parsed) ? JSON.stringify(parsed) : JSON.stringify(parsed ? [parsed] : []));
            } catch (e) {
                $hiddenField.val(currentValue && currentValue !== '[]' ? JSON.stringify([currentValue]) : '[]');
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
            function updateHiddenField() {
                var draftItemIds = uploadedFiles.map(function (file) {
                    return file.draftitemid;
                });
                $hiddenField.val(JSON.stringify(draftItemIds));
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫
            function showErrorModal(message) {
                var $modal = $('#error-modal-{{ field_id }}');
                $modal.find('.error-message').text(message);
                $modal.fadeIn(200);
            }

            function hideErrorModal() {
                $('#error-modal-{{ field_id }}').fadeOut(200);
            }

            $('#error-modal-{{ field_id }} .error-modal-close, #error-modal-{{ field_id }} .error-modal-ok, #error-modal-{{ field_id }} .error-modal-overlay').on('click', hideErrorModal);
            $('#error-modal-{{ field_id }} .error-modal-content').on('click', function (e) {
                e.stopPropagation();
            });

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö MIME —Ç–∏–ø–æ–≤ –¥–ª—è Plupload
            var allowedMimeTypes = [];
            {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}
            allowedMimeTypes = '{{ form.vars.attr['data-allowed-extensions'] }}'.split(',').map(function (type) {
                return type.trim();
            }).filter(function (type) {
                return type.length > 0;
            });
            {% endif %}

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º MIME —Ç–∏–ø—ã –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Plupload
            var mimeTypes = [];
            if (allowedMimeTypes.length > 0) {
                mimeTypes = [{
                    title: "–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã",
                    extensions: allowedMimeTypes.map(function (mime) {
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ MIME —Ç–∏–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, image/jpeg -> jpeg)
                        var parts = mime.split('/');
                        if (parts.length === 2) {
                            var ext = parts[1];
                            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
                            if (ext === 'jpeg') ext = 'jpg,jpeg';
                            return ext;
                        }
                        return '';
                    }).filter(function (ext) {
                        return ext.length > 0;
                    }).join(',')
                }];
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Plupload - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            var uploaderConfig = {
                browse_button: 'plupload-container-{{ field_id }}',
                url: '{{ upload_url }}',
                chunk_size: '1mb',
                max_file_size: (maxFileSize / 1048576) + 'mb',
                filters: {
                    max_file_size: (maxFileSize / 1048576) + 'mb',
                    prevent_duplicates: true
                },
                multipart_params: {
                    component: '{{ component }}',
                    filearea: '{{ filearea }}',
                    itemid: {{ itemid }},
                    contextid: {{ contextid }}
                    {% if userid is not null %},
                    userid: {{ userid }}
                    {% endif %}
                },
                init: {
                    PostInit: function () {
                        // –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - —Å–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
                        var maxFilesValue = {{ form.vars.attr['data-max-files']|default(1) }};
                        document.getElementById('plupload-container-{{ field_id }}').innerHTML =
                            '<button type="button" class="plupload_button">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª' + (maxFilesValue > 1 ? '—ã' : '') + '</button>';
                    },
                    FilesAdded: function (up, files) {
                        // –ï—Å–ª–∏ maxFiles = 1, —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª
                        if (maxFiles === 1 && uploadedFiles.length >= 1) {
                            var fileList = document.getElementById('plupload-filelist-{{ field_id }}');
                            fileList.innerHTML = '';
                            uploadedFiles = [];
                            updateHiddenField();
                            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏ Plupload
                            up.files = [];
                        }

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
                        if (uploadedFiles.length + files.length > maxFiles) {
                            showErrorModal('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: ' + maxFiles);
                            up.removeFile(files[files.length - 1]);
                            return;
                        }

                        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
                        var fileList = document.getElementById('plupload-filelist-{{ field_id }}');
                        plupload.each(files, function (file) {
                            var fileItem = document.createElement('div');
                            fileItem.id = file.id;
                            fileItem.className = 'plupload_file';
                            var isImage = file.type && file.type.startsWith('image/');
                            fileItem.innerHTML =
                                '<div class="plupload_file_content">' +
                                '<div class="plupload_file_preview">' +
                                (isImage ? '<img src="" alt="' + file.name + '">' : '<span style="font-size: 40px; color: #ccc;">üìÑ</span>') +
                                '</div>' +
                                '<div class="plupload_file_info">' +
                                '<div class="plupload_file_name">' + file.name + '</div>' +
                                '<div class="plupload_file_size">' + plupload.formatSize(file.size) + '</div>' +
                                '<div class="plupload_file_progress"><div class="plupload_file_progress_bar" style="width: 0%"></div></div>' +
                                '</div>' +
                                '<span class="plupload_file_status uploading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>' +
                                '</div>';
                            fileList.appendChild(fileItem);

                            // –ü—Ä–µ–≤—å—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                            if (isImage) {
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    var img = fileItem.querySelector('.plupload_file_preview img');
                                    if (img) img.src = e.target.result;
                                };
                                reader.readAsDataURL(file.getNative());
                            }
                        });

                        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        up.start();
                    },
                    UploadProgress: function (up, file) {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                        var fileItem = document.getElementById(file.id);
                        if (fileItem) {
                            var progress = file.percent;
                            var progressBar = fileItem.querySelector('.plupload_file_progress_bar');
                            if (progressBar) {
                                progressBar.style.width = progress + '%';
                            }
                        }
                    },
                    FileUploaded: function (up, file, response) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                        var fileItem = document.getElementById(file.id);
                        if (!fileItem) return;

                        try {
                            var result = JSON.parse(response.response);
                            if (result.result && result.result.draftitemid) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ñ–∞–π–ª–∞ - —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –∏ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                                var isImage = result.result.url && file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                                var previewHtml = '';
                                if (isImage && result.result.url) {
                                    previewHtml = '<img src="' + result.result.url + '" alt="' + result.result.name + '">';
                                } else {
                                    previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                                }

                                fileItem.setAttribute('data-draftitemid', result.result.draftitemid);
                                fileItem.innerHTML =
                                    '<div class="plupload_file_content">' +
                                    '<div class="plupload_file_preview">' + previewHtml + '</div>' +
                                    '<div class="plupload_file_info">' +
                                    '<div class="plupload_file_name">' + result.result.name + '</div>' +
                                    '<div class="plupload_file_size">' + plupload.formatSize(result.result.size) + '</div>' +
                                    '</div>' +
                                    '<button type="button" class="plupload_file_action delete" data-draftitemid="' + result.result.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                                    '</div>';

                                uploadedFiles.push({
                                    draftitemid: result.result.draftitemid,
                                    filename: result.result.name
                                });
                                updateHiddenField();
                            }
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞', e);
                            fileItem.remove();
                        }
                    },
                    Error: function (up, err) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        var errorMessage = err.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';
                        if (err.code === plupload.FILE_SIZE_ERROR) {
                            errorMessage = '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ' + (maxFileSize / 1048576).toFixed(2) + ' –ú–ë';
                        } else if (err.code === plupload.FILE_EXTENSION_ERROR) {
                            errorMessage = '–¢–∏–ø —Ñ–∞–π–ª–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω';
                        } else if (err.response) {
                            try {
                                var errorResponse = JSON.parse(err.response);
                                if (errorResponse.error && errorResponse.error.message) {
                                    errorMessage = errorResponse.error.message;
                                }
                            } catch (e) {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            }
                        }

                        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ñ–∞–π–ª–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        if (err.file && err.file.id) {
                            var fileItem = document.getElementById(err.file.id);
                            if (fileItem) {
                                fileItem.remove();
                            }
                        }

                        showErrorModal(errorMessage);
                    }
                }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º mime_types –≤ filters –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã
            if (mimeTypes.length > 0) {
                uploaderConfig.filters.mime_types = mimeTypes;
            }

            var uploader = new plupload.Uploader(uploaderConfig);
            uploader.init();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
            if (fileData && Array.isArray(fileData) && fileData.length > 0) {
                var fileList = document.getElementById('plupload-filelist-{{ field_id }}');
                fileData.forEach(function (file) {
                    var fileItem = document.createElement('div');
                    fileItem.className = 'plupload_file';
                    fileItem.setAttribute('data-draftitemid', file.draftitemid);
                    var isImage = file.mimetype && file.mimetype.startsWith('image/');
                    var previewHtml = '';
                    if (isImage && file.download_url) {
                        previewHtml = '<img src="' + file.download_url + '" alt="' + file.filename + '">';
                    } else {
                        previewHtml = '<span style="font-size: 40px; color: #ccc;">üìÑ</span>';
                    }

                    fileItem.innerHTML =
                        '<div class="plupload_file_content">' +
                        '<div class="plupload_file_preview">' + previewHtml + '</div>' +
                        '<div class="plupload_file_info">' +
                        '<div class="plupload_file_name">' + file.filename + '</div>' +
                        '<div class="plupload_file_size">' + (file.filesize / 1024).toFixed(2) + ' KB</div>' +
                        '</div>' +
                        '<button type="button" class="plupload_file_action delete" data-draftitemid="' + file.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                        '</div>';
                    fileList.appendChild(fileItem);

                    uploadedFiles.push({
                        draftitemid: file.draftitemid,
                        filename: file.filename
                    });
                });
                updateHiddenField();
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            $(document).on('click', '#plupload-filelist-{{ field_id }} .delete', function () {
                var draftitemid = $(this).data('draftitemid');
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                    uploadedFiles = uploadedFiles.filter(function (file) {
                        return file.draftitemid !== draftitemid;
                    });
                    updateHiddenField();
                    $(this).closest('.plupload_file').remove();
                }
            });
        } // –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ initPlupload

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPlupload);
        } else {
            initPlupload();
        }
    })();
</script>

