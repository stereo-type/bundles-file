{# Bluimp (Blueimp File Upload) Widget #}
<div id="bluimp-{{ field_id }}" class="slcorp-file-uploader bluimp-wrapper">
    <div class="fileupload-buttonbar">
        <div class="fileupload-buttons">
            <span class="fileinput-button">
                <span>{% if form.vars.attr['data-max-files']|default(1) > 1 %}{{ 'slcorp_file.bluimp.select_files'|trans }}{% else %}{{ 'slcorp_file.bluimp.select_file'|trans }}{% endif %}</span>
                <input type="file"
                       name="files[]"{% if form.vars.attr['data-max-files']|default(1) > 1 %} multiple{% endif %}>
            </span>
        </div>
    </div>
    <div class="files"></div>
</div>

{# Модальное окно для ошибок #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>{{ 'slcorp_file.bluimp.error'|trans }}</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">⚠️</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">{{ 'slcorp_file.bluimp.ok'|trans }}</button>
        </div>
    </div>
</div>

{# Скрытое поле для хранения массива draft itemid (JSON) - всегда массив #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# Подключение jQuery (если еще не подключен) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

{# Подключение Blueimp File Upload библиотеки из бандла #}
<link href="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-ui.css') }}" rel="stylesheet">
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.ui.widget.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.iframe-transport.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-process.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-validate.js') }}"></script>
<script src="{{ asset('bundles/slcorpfile/vendor/jquery-file-upload/jquery.fileupload-ui.js') }}"></script>

{# Подключение стилей #}
<link href="{{ asset('bundles/slcorpfile/css/bluimp-widget.css') }}" rel="stylesheet">

{# Подключение JavaScript #}
<script src="{{ asset('bundles/slcorpfile/js/bluimp-widget.js') }}"></script>

{# Инициализация виджета #}
<script>
    (function () {
        'use strict';

        // Получаем переводы
        var translations = {
            select_file: {{ 'slcorp_file.bluimp.select_file'|trans|json_encode|raw }},
            select_files: {{ 'slcorp_file.bluimp.select_files'|trans|json_encode|raw }},
            delete: {{ 'slcorp_file.bluimp.delete'|trans|json_encode|raw }},
            cancel: {{ 'slcorp_file.bluimp.cancel'|trans|json_encode|raw }},
            error: {{ 'slcorp_file.bluimp.error'|trans|json_encode|raw }},
            ok: {{ 'slcorp_file.bluimp.ok'|trans|json_encode|raw }},
            max_files_exceeded: {{ 'slcorp_file.bluimp.max_files_exceeded'|trans|json_encode|raw }},
            file_too_big: {{ 'slcorp_file.bluimp.file_too_big'|trans|json_encode|raw }},
            file_type_not_allowed: {{ 'slcorp_file.bluimp.file_type_not_allowed'|trans|json_encode|raw }},
            upload_error: {{ 'slcorp_file.bluimp.upload_error'|trans|json_encode|raw }},
            delete_confirmation: {{ 'slcorp_file.bluimp.delete_confirmation'|trans|json_encode|raw }}
        };

        // Конфигурация для инициализации
        var widgetConfig = {
            containerId: 'bluimp-{{ field_id }}',
            hiddenFieldId: '{{ field_id }}',
            uploadUrl: '{{ upload_url }}',
            fieldName: '{{ field_name }}',
            maxFiles: {{ form.vars.attr['data-max-files']|default(1) }},
            maxFileSize: {{ form.vars.attr['data-max-size']|default(5242880) }},
            allowedExtensions: {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}'{{ form.vars.attr['data-allowed-extensions'] }}'
            {% else %}null{% endif %},
            params: {
                component: '{{ component }}',
                filearea: '{{ filearea }}',
                itemid: {{ itemid }},
                contextid: {{ contextid }},
                userid: {{ userid|default('null') }}
            },
            fileData: {{ file_data|json_encode|raw }},
            translations: translations
        };

        // Функция инициализации виджета
        function initBluimpWidget() {
            // Проверяем, что jQuery загружен
            if (typeof jQuery === 'undefined') {
                console.error('[SlcorpFileBundle] jQuery is not loaded');
                return false;
            }

            // Проверяем, что Blueimp File Upload загружен
            if (typeof jQuery.fn.fileupload === 'undefined') {
                console.error('[SlcorpFileBundle] Blueimp File Upload plugin is not loaded');
                return false;
            }

            // Проверяем, что наш виджет загружен
            if (typeof window.SlcorpFileBundle === 'undefined' || typeof window.SlcorpFileBundle.BluimpWidget !== 'function') {
                console.error('[SlcorpFileBundle] SlcorpFileBundle.BluimpWidget is not loaded');
                return false;
            }

            // Инициализируем виджет
            try {
                window.SlcorpFileBundle.BluimpWidget(widgetConfig);
                return true;
            } catch (e) {
                console.error('[SlcorpFileBundle] Error initializing Bluimp widget:', e);
                return false;
            }
        }

        // Инициализируем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBluimpWidget);
        } else {
            // DOM уже загружен, инициализируем сразу
            initBluimpWidget();
        }
    })();
</script>
