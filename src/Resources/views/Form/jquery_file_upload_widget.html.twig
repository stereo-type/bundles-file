{# jQuery File Upload Widget #}
<div id="jquery-file-upload-{{ field_id }}" class="slcorp-file-uploader jquery-file-upload">
    <div class="fileupload-buttonbar">
        <div class="fileupload-buttons">
            <span class="fileinput-button">
                <span>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª{% if form.vars.attr['data-max-files']|default(1) > 1 %}—ã{% endif %}</span>
                <input type="file"
                       name="files[]"{% if form.vars.attr['data-max-files']|default(1) > 1 %} multiple{% endif %}>
            </span>
            <button type="button" class="delete" style="display: none;">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>
    <div class="files"></div>
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ #}
<div id="error-modal-{{ field_id }}" class="error-modal" style="display: none;">
    <div class="error-modal-overlay"></div>
    <div class="error-modal-content">
        <div class="error-modal-header">
            <h3>–û—à–∏–±–∫–∞</h3>
            <button type="button" class="error-modal-close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p class="error-message"></p>
        </div>
        <div class="error-modal-footer">
            <button type="button" class="error-modal-ok">–û–ö</button>
        </div>
    </div>
</div>

{# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ draft itemid (JSON) - –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ #}
<input type="hidden" id="{{ field_id }}" name="{{ field_name }}"
       value="{% if file_data %}{{ file_data|map(f => f.draftitemid)|json_encode|raw }}{% else %}{{ value|default('[]') }}{% endif %}"/>

{# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery File Upload –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ #}
<link href="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/css/jquery.fileupload.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/css/jquery.fileupload-ui.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/vendor/jquery.ui.widget.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.iframe-transport.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-process.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-image.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-validate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-file-upload@10.32.0/js/jquery.fileupload-ui.js"></script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è jQuery File Upload */
    #jquery-file-upload-{{ field_id }} {
        font-family: Arial, sans-serif;
    }

    #jquery-file-upload-{{ field_id }} .fileupload-buttonbar {
        margin-bottom: 20px;
    }

    #jquery-file-upload-{{ field_id }} .fileupload-buttons {
        display: flex;
        gap: 10px;
    }

    #jquery-file-upload-{{ field_id }} .fileinput-button {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    #jquery-file-upload-{{ field_id }} .fileinput-button input {
        position: absolute;
        top: 0;
        right: 0;
        margin: 0;
        opacity: 0;
        -ms-filter: 'alpha(opacity=0)';
        font-size: 200px;
        direction: ltr;
        cursor: pointer;
    }

    #jquery-file-upload-{{ field_id }} .fileinput-button span {
        display: inline-block;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    #jquery-file-upload-{{ field_id }} .fileinput-button:hover span {
        background: #0056b3;
    }

    #jquery-file-upload-{{ field_id }} .files {
        margin-top: 20px;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .preview {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .name {
        flex: 1;
        margin-right: 15px;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .size {
        margin-right: 15px;
        color: #666;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .delete {
        padding: 5px 10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #jquery-file-upload-{{ field_id }} .files .template-download .delete:hover {
        background: #c82333;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .preview {
        width: 80px;
        height: 80px;
        margin-right: 15px;
        border-radius: 4px;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .name {
        flex: 1;
        margin-right: 15px;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .size {
        margin-right: 15px;
        color: #666;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .progress {
        width: 200px;
        height: 20px;
        margin-right: 15px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .progress .progress-bar {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .cancel {
        padding: 5px 10px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #jquery-file-upload-{{ field_id }} .files .template-upload .cancel:hover {
        background: #5a6268;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–æ–∫ */
    #error-modal-{{ field_id }} {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #error-modal-{{ field_id }} .error-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    #error-modal-{{ field_id }} .error-modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #error-modal-{{ field_id }} .error-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    #error-modal-{{ field_id }} .error-modal-header h3 {
        margin: 0;
        color: white;
        font-size: 20px;
        font-weight: 600;
    }

    #error-modal-{{ field_id }} .error-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    #error-modal-{{ field_id }} .error-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    #error-modal-{{ field_id }} .error-modal-body {
        padding: 30px 24px;
        text-align: center;
    }

    #error-modal-{{ field_id }} .error-icon {
        font-size: 64px;
        margin-bottom: 20px;
        animation: errorPulse 2s infinite;
    }

    @keyframes errorPulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
    }

    #error-modal-{{ field_id }} .error-message {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        word-wrap: break-word;
    }

    #error-modal-{{ field_id }} .error-modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e9ecef;
        text-align: right;
        background: #f8f9fa;
    }

    #error-modal-{{ field_id }} .error-modal-ok {
        padding: 10px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    #error-modal-{{ field_id }} .error-modal-ok:hover {
        background: #c82333;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    }

    #error-modal-{{ field_id }} .error-modal-ok:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
</style>

<script>
    (function () {
        'use strict';

        var $container = $('#jquery-file-upload-{{ field_id }}');
        var $filesContainer = $container.find('.files');
        var $hiddenField = $('#{{ field_id }}');
        var maxFiles = {{ form.vars.attr['data-max-files']|default(1) }};
        var maxFileSize = {{ form.vars.attr['data-max-size']|default(5242880) }};
        var allowedExtensions = '{{ form.vars.attr['data-allowed-extensions']|default('') }}';
        var fileData = {{ file_data|json_encode|raw }};
        var uploadedFiles = [];

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ - –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤ (JSON)
        var currentValue = $hiddenField.val() || '[]';
        try {
            var parsed = JSON.parse(currentValue);
            if (!Array.isArray(parsed)) {
                $hiddenField.val(parsed ? JSON.stringify([parsed]) : '[]');
            } else {
                $hiddenField.val(JSON.stringify(parsed));
            }
        } catch (e) {
            if (currentValue && currentValue !== '[]') {
                $hiddenField.val(JSON.stringify([currentValue]));
            } else {
                $hiddenField.val('[]');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        if (fileData && Array.isArray(fileData) && fileData.length > 0) {
            console.log('jQuery File Upload: –∑–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤', fileData);
            fileData.forEach(function (file) {
                addExistingFile(file);
            });
        }

        function addExistingFile(file) {
            var $template = $('<div class="template-download">' +
                '<div class="preview">' +
                (file.mimetype && file.mimetype.startsWith('image/') ?
                    '<img src="' + (file.download_url || '') + '" alt="' + escapeHtml(file.filename) + '">' :
                    '<span>üìÑ</span>') +
                '</div>' +
                '<div class="name">' + escapeHtml(file.filename) + '</div>' +
                '<div class="size">' + formatFileSize(file.filesize) + '</div>' +
                '<button type="button" class="delete" data-draftitemid="' + file.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                '</div>');

            $filesContainer.append($template);
            uploadedFiles.push({
                draftitemid: file.draftitemid,
                filename: file.filename
            });
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) {
                return map[m];
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function updateHiddenField() {
            var draftItemIds = uploadedFiles.map(function (file) {
                return file.draftitemid;
            });
            $hiddenField.val(JSON.stringify(draftItemIds));
            console.log('jQuery File Upload: draftitemid –æ–±–Ω–æ–≤–ª–µ–Ω', draftItemIds);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—à–∏–±–∫–æ–π
        function showErrorModal(message) {
            var $modal = $('#error-modal-{{ field_id }}');
            var $message = $modal.find('.error-message');
            $message.text(message);
            $modal.fadeIn(200);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function hideErrorModal() {
            var $modal = $('#error-modal-{{ field_id }}');
            $modal.fadeOut(200);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        $('#error-modal-{{ field_id }} .error-modal-close, #error-modal-{{ field_id }} .error-modal-ok, #error-modal-{{ field_id }} .error-modal-overlay').on('click', function () {
            hideErrorModal();
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
        $('#error-modal-{{ field_id }} .error-modal-content').on('click', function (e) {
            e.stopPropagation();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è jQuery File Upload
        var allowedMimeTypes = [];
        {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}
        allowedMimeTypes = '{{ form.vars.attr['data-allowed-extensions'] }}'.split(',').map(function (type) {
            return type.trim();
        }).filter(function (type) {
            return type.length > 0;
        });
        {% endif %}

        $container.find('input[type="file"]').fileupload({
            url: '{{ upload_url }}',
            dataType: 'json',
            autoUpload: true,
            maxNumberOfFiles: maxFiles,
            maxFileSize: maxFileSize,
            {% if form.vars.attr['data-allowed-extensions'] is defined and form.vars.attr['data-allowed-extensions'] %}
            accept: function (file) {
                if (allowedMimeTypes.length === 0) {
                    return true;
                }
                return allowedMimeTypes.indexOf(file.type) !== -1;
            },
            {% endif %}
            formData: function () {
                return [
                    {name: 'component', value: '{{ component }}'},
                    {name: 'filearea', value: '{{ filearea }}'},
                    {name: 'itemid', value: {{ itemid }}},
                    {name: 'contextid', value: {{ contextid }}}
                    {% if userid is not null %},
                    {name: 'userid', value: {{ userid }}}
                    {% endif %}
                ];
            },
            add: function (e, data) {
                // –ï—Å–ª–∏ maxFiles = 1, —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª
                if (maxFiles === 1 && uploadedFiles.length >= 1) {
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
                    $filesContainer.find('.template-download').each(function () {
                        var $template = $(this);
                        var draftitemid = $template.find('.delete').data('draftitemid');
                        uploadedFiles = uploadedFiles.filter(function (file) {
                            return file.draftitemid !== draftitemid;
                        });
                        $template.remove();
                    });
                    updateHiddenField();
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
                if (uploadedFiles.length >= maxFiles) {
                    showErrorModal('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤: ' + maxFiles);
                    return false;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                if (data.files[0].size > maxFileSize) {
                    showErrorModal('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ' + formatFileSize(maxFileSize));
                    return false;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –æ—á–µ—Ä–µ–¥—å
                var $template = $('<div class="template-upload">' +
                    '<div class="preview"></div>' +
                    '<div class="name">' + escapeHtml(data.files[0].name) + '</div>' +
                    '<div class="size">' + formatFileSize(data.files[0].size) + '</div>' +
                    '<div class="progress"><div class="progress-bar" style="width: 0%"></div></div>' +
                    '<button type="button" class="cancel">–û—Ç–º–µ–Ω–∏—Ç—å</button>' +
                    '</div>');

                $filesContainer.append($template);

                // –ï—Å–ª–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                if (data.files[0].type && data.files[0].type.startsWith('image/')) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $template.find('.preview').html('<img src="' + e.target.result + '" alt="' + escapeHtml(data.files[0].name) + '">');
                    };
                    reader.readAsDataURL(data.files[0]);
                } else {
                    $template.find('.preview').html('<span>üìÑ</span>');
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
                $template.find('.cancel').on('click', function () {
                    data.abort();
                    $template.remove();
                });

                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                data.submit();
            },
            progress: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                var $template = data.context || $filesContainer.find('.template-upload').last();
                $template.find('.progress-bar').css('width', progress + '%');
            },
            done: function (e, data) {
                console.log('jQuery File Upload: —É—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞', data.result);
                var $template = data.context || $filesContainer.find('.template-upload').last();

                if (data.result && Array.isArray(data.result) && data.result.length > 0) {
                    var file = data.result[0];
                    if (file.draftitemid) {
                        // –ó–∞–º–µ–Ω—è–µ–º —à–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —à–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
                        var $downloadTemplate = $('<div class="template-download">' +
                            '<div class="preview">' +
                            (file.thumbnailUrl ?
                                '<img src="' + file.thumbnailUrl + '" alt="' + escapeHtml(file.name) + '">' :
                                '<span>üìÑ</span>') +
                            '</div>' +
                            '<div class="name">' + escapeHtml(file.name) + '</div>' +
                            '<div class="size">' + formatFileSize(file.size) + '</div>' +
                            '<button type="button" class="delete" data-draftitemid="' + file.draftitemid + '">–£–¥–∞–ª–∏—Ç—å</button>' +
                            '</div>');

                        $template.replaceWith($downloadTemplate);

                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                        uploadedFiles.push({
                            draftitemid: file.draftitemid,
                            filename: file.name
                        });

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                        updateHiddenField();
                    } else {
                        console.error('jQuery File Upload: response –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç draftitemid', data.result);
                        $template.remove();
                    }
                } else {
                    console.error('jQuery File Upload: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', data.result);
                    $template.remove();
                }
            },
            processfail: function (e, data) {
                console.error('jQuery File Upload: –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞', data);
                var $template = data.context || $filesContainer.find('.template-upload').last();
                var errorMessage = '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞';

                if (data.files && data.files[0]) {
                    if (data.files[0].error) {
                        errorMessage = data.files[0].error;
                    } else if (allowedMimeTypes.length > 0 && data.files[0].type && allowedMimeTypes.indexOf(data.files[0].type) === -1) {
                        errorMessage = '–¢–∏–ø —Ñ–∞–π–ª–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω. –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã: ' + allowedMimeTypes.join(', ');
                    } else if (data.files[0].size > maxFileSize) {
                        errorMessage = '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ' + formatFileSize(maxFileSize);
                    }
                }

                showErrorModal(errorMessage);
                if ($template.length) {
                    $template.remove();
                }
            },
            fail: function (e, data) {
                console.error('jQuery File Upload: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', data);
                var $template = data.context || $filesContainer.find('.template-upload').last();
                var errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';

                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                if (data.result) {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª JSON —Å –æ—à–∏–±–∫–æ–π
                    if (data.result.error) {
                        errorMessage = data.result.error;
                    } else if (typeof data.result === 'string') {
                        errorMessage = data.result;
                    } else if (data.result[0] && data.result[0].error) {
                        errorMessage = data.result[0].error;
                    }
                } else if (data.jqXHR) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º responseJSON
                    if (data.jqXHR.responseJSON) {
                        if (data.jqXHR.responseJSON.error) {
                            errorMessage = data.jqXHR.responseJSON.error;
                        } else if (data.jqXHR.responseJSON.message) {
                            errorMessage = data.jqXHR.responseJSON.message;
                        } else if (typeof data.jqXHR.responseJSON === 'string') {
                            errorMessage = data.jqXHR.responseJSON;
                        }
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º responseText (–º–æ–∂–µ—Ç –±—ã—Ç—å JSON —Å—Ç—Ä–æ–∫–∞)
                    else if (data.jqXHR.responseText) {
                        try {
                            var parsed = JSON.parse(data.jqXHR.responseText);
                            if (parsed.error) {
                                errorMessage = parsed.error;
                            } else if (parsed.message) {
                                errorMessage = parsed.message;
                            } else if (typeof parsed === 'string') {
                                errorMessage = parsed;
                            }
                        } catch (e) {
                            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å (–Ω–æ –æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)
                            var responseText = data.jqXHR.responseText.trim();
                            if (responseText.length > 0 && responseText.length < 500) {
                                errorMessage = responseText;
                            }
                        }
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (data.jqXHR.status) {
                        var statusMessages = {
                            400: '–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å',
                            401: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                            403: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω',
                            404: '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω',
                            413: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π',
                            415: '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞',
                            500: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                            502: '–û—à–∏–±–∫–∞ —à–ª—é–∑–∞',
                            503: '–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
                        };

                        if (statusMessages[data.jqXHR.status] && errorMessage === '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞') {
                            errorMessage = statusMessages[data.jqXHR.status];
                            if (data.jqXHR.statusText) {
                                errorMessage += ' (' + data.jqXHR.statusText + ')';
                            }
                        } else if (data.jqXHR.statusText && errorMessage === '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞') {
                            errorMessage = data.jqXHR.statusText;
                        }
                    }
                } else if (data.textStatus) {
                    // textStatus –º–æ–∂–µ—Ç –±—ã—Ç—å: 'error', 'timeout', 'abort', 'parsererror'
                    var statusMessages = {
                        'error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞',
                        'timeout': '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è',
                        'abort': '–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞',
                        'parsererror': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞'
                    };
                    errorMessage = statusMessages[data.textStatus] || data.textStatus;
                }

                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                if (errorMessage === '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞' && data.files && data.files[0]) {
                    errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ "' + data.files[0].name + '"';
                }

                showErrorModal(errorMessage);
                if ($template.length) {
                    $template.remove();
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        $filesContainer.on('click', '.delete', function () {
            var $button = $(this);
            var draftitemid = $button.data('draftitemid');
            var $template = $button.closest('.template-download');

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π confirm, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ –æ—à–∏–±–∫–∞
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
                uploadedFiles = uploadedFiles.filter(function (file) {
                    return file.draftitemid !== draftitemid;
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                updateHiddenField();

                // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
                $template.remove();
                console.log('jQuery File Upload: —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω', draftitemid);
            }
        });
    })();
</script>

